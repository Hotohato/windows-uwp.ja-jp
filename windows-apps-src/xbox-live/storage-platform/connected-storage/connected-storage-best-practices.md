---
title: 接続ストレージのベスト プラクティス
author: aablackm
description: 接続ストレージによってパフォーマンスとエクスペリエンスを最大限に高める方法に関する推奨事項
ms.author: aablackm
ms.date: 02/27/2018
ms.topic: article
ms.prod: windows
ms.technology: uwp
keywords: xbox live, xbox, ゲーム, uwp, windows 10, xbox one, 接続ストレージ
ms.localizationpriority: medium
ms.openlocfilehash: 936b0333e826d3f9047a6905e7374e1ce9ec47ca
ms.sourcegitcommit: 82c3fc0b06ad490c3456ad18180a6b23ecd9c1a7
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 10/24/2018
ms.locfileid: "5471220"
---
# <a name="connected-storage-best-practices"></a>接続ストレージのベスト プラクティス

デベロッパーは、単一のセーブ データを書き込むのではなく、セーブ データを、単独で更新可能な論理グループに分割する必要があります。 そうすることで、タイトルでさまざまな状況において書き込むデータの量を削減し、ローカル リソースの消費とアップロードでの帯域幅使用の両方を減らすことができます。 この API を使用して、タイトルで、完全に成功するか、または (セーブ中に致命的なエラーが発生した場合などに) まったく効力を生じないことが保証されるアトミック操作で複数のデータ アイテムを更新することもできます。

Xbox One では、ユーザーがタイトルをすばやく切り替えることができるため、デベロッパーは、事実上常に発生する可能性のある一時停止イベントの受け取りを見越して、すぐに現在の状態を保存できるようにタイトルを設計する必要があります。 接続ストレージ API では、短い一時停止期間中のタイトルの書き込み速度を最大限に高めるために、タイトル用に予約されていない部分の RAM を保存の最初のポイントとして使用します。 その後、システムはデータを永続的なストレージに保持して、ストレージと最後のアップロード以降のその他のデータ書き込みを照合し、データのアップロードをスケジュールします。 格納され、キューに入れられてアップロードされると、システムは、ネットワーク接続の損失や電源障害などのさまざまな障害に対して堅牢になります。

## <a name="when-to-load-a-users-connected-storage-space-data"></a>ユーザーの接続ストレージ領域データを読み込むタイミング

ユーザーの接続ストレージ データ領域を読み込むための実行時間は変動する可能性があります。 アプリでは、ユーザーがサインアウトを開始したことに対する応答、またはシステムから一時停止通知を受け取ったことに対する応答としてではなく、メインの実行中にこの処理を行う必要があります。
セーブ機能が必要でないことが明らかなモードにゲームがなっていない限り、通常は、ユーザーがサインインし、プレイする意思を示した時点でアプリは接続ストレージ領域を読み込む必要があります。 接続ストレージ領域の読み込みを、長い一連のデータ読み込みに合わせることで、並列処理を可能にすることも検討してください。
アプリでは、ユーザーの接続ストレージ領域データを読み込んだら、将来のセーブで使用するためにこの値を保持する必要があります。 接続ストレージ領域を長時間保持しても、パフォーマンスや堅牢性への悪影響はありません。 システムがオンラインの場合、接続ストレージ領域の読み込み時にクラウドとの同期チェックが行われるため、ネットワークが低速または信頼性が低いときにユーザーの接続ストレージ領域を解放および再読み込みすると、システムがタイムアウトするまで、ユーザーに同期 UI が表示される場合があります。クラウドの同期を実行させるために接続ストレージ領域を明示的に解放する必要はありません。 `SubmitUpdatesAsync` 呼び出しで指定された完了ハンドラーから `AsyncStatus::Completed` が返されると、アプリが `ConnectedStorageSpace` オブジェクトを解放するかどうかにかかわらず、システムがクラウドとの同期を処理します。

## <a name="when-to-save"></a>セーブするタイミング

アプリで一時停止通知を受け取るたびに、アプリでは少なくとも、関連データをセーブして、システムがコンテキストに応じてユーザーの適切な状態に戻れるようにする必要があります。

定期的な、自動的な、またはユーザーが開始するセーブをゲームの設計で使用している場合、一時停止通知を受け取ったとき以外にも接続ストレージを呼び出すことができます。これは、停電やクラッシュなどでデータが失われるリスクを低減できるため推奨されます。
XDK を使ってゲームを開発している場合、ユーザーがサインアウトした場合でも、そのユーザーの User オブジェクトは有効なままであり、その時点でアプリは接続ストレージを使用して最終的なセーブ操作を実行できます。

## <a name="robustness"></a>信頼性

セーブ データは常にクラウドに同期されるため、アプリのクラッシュの原因になるバグがセーブ データやアプリのコードに含まれると、そのバグがクラウドにバックアップされ、複数のデバイスに波及する可能性があります。 起動のたびにクラッシュするアプリがユーザーの手に渡らないようにするために、以下が保証されるようアプリを設計してください。

-   セーブ データの一部の形式が正しくない場合でも、ユーザーはアプリ内のあるポイントまで到達して、セーブ状態を管理することができます。
-   アプリは破損したデータを自動的に処理して、できるだけ多くのデータを復元し、他のデータはすべて安全な状態に再初期化することができます。

## <a name="use-cases-for-save-game-designs"></a>ゲーム セーブ設計の使用事例

接続ストレージ領域内のコンテナーを最大限に活用するゲーム セーブ システムの設計は、アプリのタイプによって異なります。

### <a name="single-save"></a>単一のセーブ

単一のキャンペーン スタイルのセーブ システムを使用するアプリ (一人称視点のシューティング ゲームなど) の場合:

-   すべてのデータを単一のコンテナーに格納し、常に、名前で識別される同じコンテナーに書き込みます。
-   ユーザーが、これまでの進行状況を保持せずにアプリを最初からプレイすることを希望した場合のために、ユーザーのすべてのセーブ データをクリアするための、全データをリセットするオプションを公開することを検討してください。

### <a name="multiple-saves"></a>複数のセーブ

一定数のセーブ スロット (たとえば、5 つ) があるアプリの場合は、コンテナーを使用してゲーム データをセーブするための方法が 2 つあります。

-   セーブ スロットごとに 1 つの BLOB を使用して、名前が固定された 1 つのコンテナー内に 5 つのスロットすべてを格納します。 この方法を使うと、5 つスロットすべてが完全に同期され、利用可能になります。または、何らかの時点で同期が失敗した場合、どのスロットも同期されず、以前の状態のままになります。 ユーザーが 2 台の異なる本体でアプリをオフラインでプレイし、進行状況を 1 台目の本体のスロット 1 と 2 台目の本体のスロット 2 にセーブした場合、ユーザーは、両方の本体を Xbox Live に接続したときにどちらのデータを保持するかを選択する必要があります。コンテナーの結合ロジックで競合が発生するためです。
-   各スロットをそれぞれ独自の名前を持つコンテナーに格納します。 これにより、オフラインになる可能性のある複数のマシン上でも、独立した進行状況が各スロットに保持されます。 ただし、ユーザーが同期を途中でキャンセルした場合、そのセッション中は一部のスロットしか使用できなくなる場合があります。一部のコンテナーでダウンロードが完了していない可能性があるためです。 そのような場合、ユーザーには、同期が完了しなかったことと、クラウド データの一部がローカルの本体に存在しないことが通知されます。

どちらの方法を使用する場合でも、アプリでは、個々のセーブ データをスロットから削除するための UI をユーザーに提供する必要があります。

### <a name="warning"></a>警告

**依存関係のあるデータをコンテナーをまたいで格納しないでください。** 依存関係のあるデータを複数のコンテナーをまたいで格納しないでください。 不完全な同期、停電、またはその他のエラー状況によって、コンテナーが分離される場合があります。 1 つのコンテナーに格納されるデータは、そのコンテナー内で自足し、一貫している必要があります。

### <a name="tips"></a>ヒント

**ユーザーが本体の電源を切ったり、アプリを離れたりすることを妨げないでください。** タイトルでは、セーブ時にユーザーが本体の電源を切ったり、アプリを離れたりすることを妨げないでください。 Xbox 360 では、タイトルでセーブが実行されているときにユーザーがシステムの電源を切ると、ユーザーのデータはセーブされません。 Xbox One では、タイトルは一時停止イベントを受信し、接続ストレージ API を使用して状態をセーブする時間が 1 秒あります。 システムが完全にシャットダウンするか低電力状態になる前に、データがハード ドライブに適切にコミットされることがシステムで保証されています。 ユーザーが別のタイトルをプレイするためにタイトルのディスクを取り出した場合も、同じ一時停止プロセスが実行されます。

**接続ストレージ領域を保持します。** ConnectedStorageSpace オブジェクトを、読み取りまたは書き込みイベントが発生するたびに読み込むのではなく、保持するようにします。 ConnectedStorageSpace オブジェクトを長期間保持することによってパフォーマンスや堅牢性に悪影響が出ることはありません。

**データ サイズを小さくします。** セーブ データのサイズを小さくします。 本体がオンラインのときに、接続ストレージ内のすべてのユーザー データがクラウドにアップロードされます。 データ形式を最適化して、遅延と帯域幅の使用量が最小限に抑えられるようにしてください。

**ユーザーがセーブを必要としていないことを確認します。** GetForUserAsync および SubmitUpdatesAsync から OutOfLocalStorage エラーが返されていないかどうかをチェックし、ユーザーに質問して、本当にセーブせずにプレイするかどうかを確認します。 ユーザーがゲームをセーブすることを希望する場合は、操作を再試行します。

**ユーザーのクォータをチェックし、領域をクリアするよう要求します。** SubmitUpdatesAsync によって QuotaExceeded エラーが返されていないかチェックします。 アプリでこのメッセージを受け取った場合は、領域をいくらか空けるまで新しいデータをセーブできないことをユーザーに通知し、そのための UI を表示します。 各ユーザーにはアプリあたり 256 MB または 64 MB のデータ領域が割り当てられ、各 XDK タイトルにはマシンあたり 64 MB のストレージが割り当てられます (本体に対してローカル)。

**後で復元できるようにメニューの状態を保存します。** コアのゲーム データに加えて、メニューの状態およびその他のアプリ設定を保存します。 ユーザーが別のアプリをプレイしてから元のアプリに戻ってきた場合、コンテキストに応じて適切なメニュー状態を復元します。
サインインしているユーザーの変化に対応します。 アプリが一時停止されている間にユーザーがサインアウトする可能性があります。 アプリが再開されるとき、サインインしていた一連のユーザーが変わっていないかどうかを確認する必要があります。 変わっている場合にメニューなどのアプリ内の適切な位置に移動することを検討してください。

**セーブ データを管理するための UI を提供します。** アプリでは、ユーザーがアプリ内でセーブ データを管理できる UI を提供する必要があります。 自動セーブ システムを備えたアプリの場合は、ユーザーが既定のプレイ状態にリセットできるように、セーブ データをリセットするオプションを提供してください。

**セーブ データを管理するための UI にユーザーが常にアクセスできるようにします。** アプリでは、バグのあるセーブ データが存在する場合でも、セーブ データの管理 UI にユーザーが常にアクセスできるようにしてください。 アプリのバグまたはデータの破損によってユーザーのセーブ データが読み取り不可能になった場合に、アプリでは、クラッシュが発生しない状態、またはプレイが阻止されない状態にまで、ユーザーが回復できるようにする必要があります。