---
xx.xxxxxxx: YYxxYYxx-YYxY-YYYY-YYxY-xYYYYxYxYxYY
xxxxx: Xxxxxxxxxxx xxxxxx XxxxxxX xxx XxxxxxYX xxxxxxxxxxxxxx xxxx XxxxxXxxx xxx XxxXxxx
xxxxxxxxxxx: Xxx Xxxxxxx.XX.Xxxxxxxxxxx XXX xxxxxxxx xxxxxx xxxxxxxxxxxxxx xxxxxxxxxx xxxxxxxx xxxxxxx xx xx xxxxx xxxxxxxx xxxx xxx xxxxxxxxxx.
---
# Xxxxxxxxxxx xxxxxx XxxxxxX xxx XxxxxxYX xxxxxxxxxxxxxx xxxx XxxxxXxxx xxx XxxXxxx

\[ Xxxxxxx xxx XXX xxxx xx Xxxxxxx YY. Xxx Xxxxxxx Y.x xxxxxxxx, xxx xxx [xxxxxxx](http://go.microsoft.com/fwlink/p/?linkid=619132) \]

Xxx Xxxxxxx.XX.Xxxxxxxxxxx XXX xxxxxxxx xxx [**XXxxxxxxxxxXxxxxxx**](https://msdn.microsoft.com/library/windows/apps/Mt620068), [**XXxxxxxxxxxxXxxxxxxXxxxxxxXxxxxxx**](https://msdn.microsoft.com/library/windows/apps/Mt620058), xxx [**XXxxxxxxxxxxXxxxxxxxXxxxxxXxxxxxx**](https://msdn.microsoft.com/library/windows/apps/Mt620065) xxxxxx xxxxxxxxxxxxxx xxxxxxxxxx xxxxxxxx xxxxxxx xx xx xxxxx xxxxxxxx xxxx xxx xxxxxxxxxx.

Xxxxxx xxxxxxxxxxxxxx xx xxxxxxxxxx xxxxxx xxxxxxx xxxxxxx xxxx xxx xxxxxx xx XxxxxxX xxxxxxxx. Xxx xxxxxxxx xxx xxxxxxx xxxx x xxxxxxx xxxxxx xxxxxx [**XxxxxxxxxxxXxxxxxxxXxxxxx**](https://msdn.microsoft.com/library/windows/apps/Dn706749). Xxxx xxxxxx xx xxxxxx xx xx xxxxxxxxxx XxxxxxYX xx XxxxxxYX xxxxxx xxxxxx, xxxxx xx xxxx xx xxxxxxxx xxxxx xxxxxx xxx xxxxxxxx. Xxx xxxxxxxxxxx XXX xxxxx xxxxxxx xxx xxxxxxxxxx XxxxxxX xxxxxx. Xx xx xxx xxxxxxxxxxxxxx xx xxx xxxxxxxxxxx xx xxxxxx xxx xxx xxxx xx xx xxx **XxxxxxxxxxxXxxxxxxxXxxxxx** xxxxxx. Xx xxxxxxxxxxx xxx xxxxxx xxxx xxxx xxx **XxxxxxxxxxxXxxxxxxxXxxxxx** xxxxxx xx x xxxx, xxx xx xxx xxx xxx xxxx XxxxxxX xxxxxx xx xxx xxxxxxxxx xxxxxx xxx xxxxxxxx **XxxxxxxxxxxXxxxxxxxXxxxxx** xxxxxxx.

## Xxxxxxxx x xxxxxxx

Xxxx [**XxxxxxxxxxxXxxxxxxxXxxxxx**](https://msdn.microsoft.com/library/windows/apps/Dn706749) xxxxxx xx x xxxxxxx xxxxxxx. Xxxx xxxxxxx xx xxxxxxx xxxx xx xxxxxxx xxxx (xxxxx xxx xx Y,Y), xxx xx xxxxx xxxxxx. X xxxxxxx xx xxx xxxxxxx xxxxx xxx xx xxxxxxxxxxx xxxxxxxx xx x xxxxxx xxxx, xxx xxxxxxx, xxx x [**XxxxxxxxxxxXxxxxxxXxxxx**](https://msdn.microsoft.com/library/windows/apps/Mt589415) xxx x [**XxxxxxXxxxxx**](https://msdn.microsoft.com/library/windows/apps/Mt589433), xxx xx xxx xxxxxxx xxxxx xxx xxxxxxx xxx xx xxxxxx xx xxxxxx xxxxxx. Xx xx, xxx xxx xxxxxxxx, xxxxxxxx xxxxxxxxxxx, xxxx xx xxx xxxxxxxxx xxxxx xxxx xx “xxxxxx”.

Xxxxxxxxxxxx, XxxxxxX xxxxxxx xxx xx xxxxxxxx xxxxxxxx. Xxxx xxx xxxxxx, xxxxxxx xxxxx xxxxxxx, xx xxx xxxxxxxxxxx xxxxxx xxxxxxx xxxxxxxxx xx xxxxxxx XxxxxxX XXXx, xx xx xxx xxxxxxxx xxxxxxx xx xxxxx xx xxx xxxxxx, xx xx xxx xxxxxx xx xxxxxxx. XxxxxxYX xxx xx XXX xxxx xx xxxxxxxxxxx xxx xxx xx xxxxxxxx, xxxxxxxxxxxxxx, xx xxx xxxxxx xx xxxx xxx xxx xxxxxx. Xxxx x XxxxxxX xxxxxx xx xxxx, xxx xxxxxxxxxxx xxxx xxxxxxx xx, xxxxxx x xxx xxx, xxx xxxx xx xx xxx [**XxxxxxxxxxxXxxxxxxxXxxxxx**](https://msdn.microsoft.com/library/windows/apps/Dn706749) xxxxxxx xxxxxxxxxx xxxxxxxxxx xxxx xxx xxx XxxxxxX xxxxxx.

## Xxxxxxx xxxxxx xxxx x xxxxxxx

Xx xxxx xxxxxx xxxx xxx xxxxxxx, xxx xxxxxxxxxxx xxxx xxxx xxx [**XxxxxXxxx**](https://msdn.microsoft.com/en-us/library/windows/apps/mt620059.aspx) xxxxxx, xxxxx xxxxxxx x XxxxxxX xxxxxxxxx xxxxxxxxxxxx x xxxxxxx xx XxxxxxYX xxxxxxx, xxxxxxxxx xx xxxx xxx xxxxxxxxxxx xxxxxxxx. Xxx xxxxxxxxxxx xxxx xxxx xxxxxx xx xxxxxx xxxxxx xxxx xxxx xxxxxxx. Xxxx xxx xxxxxxxxxxx xx xxxx, xx xxxx xxxx xxx [**XxxXxxx**](https://msdn.microsoft.com/library/windows/apps/mt620060) xxxxxx. Xxxx xx xxxx xxxxx xxx xxx xxx xxxxxx xxxxxxxxx xxx xxxxxxxxxxx, xxx xxxx xxxxx xxx'x xxxx xx xx xxxxxx xxxxx xxx xxxx xxxx xxx xxxxxxx xx xxx xxxxxx xxxx xxx xxxxxxxxx. Xx xxx xxxxxx xxxx xx xxxxxxxxx xxxxxx **XxxXxxx** xx xxxxxx, xxxx xxx xxxxxx xxxx xx xx xxxxxxxx xx xxx xxxxxxx xx xxxxxx xxx xxx xxxxxxx xxxxxxxxx xx xxxxxxx xxx xxxxxxxx xx xxx xxxxx xx **XxxxxXxxx**. Xxxx **XxxXxxx** xx xxxxxx, xxx xxxxxxx xx XxxxxxYX xxxxxxx xxxxxxx xxxxxxxx xx XxxxxXxxx xx xxxxxxxxxxx. Xx xxxxxxxxxxx xxxxxx xxxxx xxxxx xxxx xxxxxxx xxxxxx xxx **XxxXxxx** xxxx.

Xxx xxxxxxxxxxx xxx xxxx xxxx XxxxxXxxx xx xxx xxxxxxx xx x xxxx, xxx xxx xxxxx [**XxxxxxxxxxxXxxxxxxxXxxxxx**](https://msdn.microsoft.com/library/windows/apps/Dn706749). Xxxxx xxxxxxx [**XxxxxXxxx**](https://msdn.microsoft.com/en-us/library/windows/apps/mt620059.aspx), xxx xxxxxxxxxxx xxxx xxxx [**XxxXxxx**](https://msdn.microsoft.com/library/windows/apps/mt620060) xx xxxx xxxxxxx xxxxxx xxxxxxx **XxxxxXxxx** xx xxxxxxx. Xx xxx XXX xx xxxxx, xxx xxxxxxxxxxx xx xxxxxxxxxxx xxx xxxxxxxxxxxxx xxxxx xxxxx xx xx xxxxxx xx xxxxxxx xxxxxxxxx xxxx xxxxxxxx xxxxxx xxxxxxx. Xx xx xxxxxxxxxxx xxxxx xx xxxxxxxxx xxxxxxxxx xxx xxxxxxx xxx xxxxxx xx xxxxxxx xxxxxxxxxxx, xxx xxxxxxxxxxx xxx xxx xxx [**XxxxxxxXxxx**](https://msdn.microsoft.com/en-us/library/windows/apps/mt620064.aspx) xxxxxx. Xxxx xxxxxx xxxxxxx **XxxxxXxxx** xx xxxxxxx, xxx xxxx xxx xxxx xxx xxxxx xxxxxxx xxxxxx xxxxxxxxx xxx xx-xxxxxx xxxxxxxxxxx. Xxxx xxxxxx xxx xxxxxxxxxxx xx xxxxxxx xxxxxxxx xxxxxxx xx x xxxxxxxxxxxxx xxxxxx. Xxxx x xxxxxxx xx xxxxxxxxx, xxx xxxxxxxxxxx xxx xxxxxxxx xxx xxxxxx xx xxxxxxx xxx [**XxxxxxXxxx**](https://msdn.microsoft.com/library/windows/apps/mt620062) xxxxxx, xx xx xxx xxxxxxx xxxx xxx xxxxxx xx xxxx xx xxxxxxx **XxxXxxx**. Xxxx xxxxx xxxx xxx xxxxxxx xxx xx xxxxxxxx xxxxxxx xx x xxxx xxx xxx xxxxx **XxxxxxxxxxxXxxxxxxxXxxxxx**. Xxxx xxxxxxxx xxxxxx xxxxx xxxx xxxxx xxxxxxxxxxxxx xx xxx xxxxxx, xx xx xxxxxxxxxxx xxx xxxxxx xx xxx xxxxxxxx xxxxxxxxxxxxxx xx xxxx xxxxxx xx xxxxxxxxx xxxxxxxx xxxxxxx. Xxxxxxx, xxxx xxxxxxxxx xxx xxxxx xxxxxx xxx xxxxx xxx xxxxxxxx xxxx xxxxx xxxxxx xxxxxxxx xxx, xx xxxx, xx xxxx xxxxxx xxxxxxxxx.

Xxx [**XxxxxXxxx**](https://msdn.microsoft.com/en-us/library/windows/apps/mt620059.aspx), [**XxxxxxxXxxx**](https://msdn.microsoft.com/en-us/library/windows/apps/mt620064.aspx), [**XxxxxxXxxx**](https://msdn.microsoft.com/library/windows/apps/mt620062) xxx [**XxxXxxx**](https://msdn.microsoft.com/library/windows/apps/mt620060) xxxxxxx xxxxxx xxxxxxxx xx xxx xxxxxxxxxxx xxxxxxxx xx xxxxxxxxx xxxxxxxxx (xxxx xx xxxxxxx xxxxxxx xxxxxxxxx, xx xxxxxxx **XxxxxXxxx** xx x xxxxxxx xxxxxx xxxxxxx **XxxXxxx** xx xxxxxxx). Xxxxx xxxxx xx xxxxxxxx xxxxxxxxx xxxxxxxxxxx xxxx xxx, xx xxxx, xxx xxxxxxxxxxx xx xxxx xxxx xxx xxxxxxx xxxx x xxxx xxxx. **XxxxxXxxx** xxx xxxx xxxxxx x xxxxxxx xx xxx xxxxxxxxxx XxxxxxX xxxxxx xx xxxx. Xxxx xxxxxxx xx xxx xxxxx xx xxx xxxxxxxxxxx xxx xxxxxxxx xxx XxxxxxX xxxxxx xxx xxx xxxxx. Xx xxxx, xxx xxxxxxxxxxx xx xxxxxxxx xx xxxxxx xxxxxx xxxx xx xxxxxx xxxxxxxx xxxxxxxxx. Xx **XxxxxXxxx** xxxxx xxx xxx xxxxxx, xxx xxxxxxxxxxx xxxxxx xxxx xxx xxxx **XxxXxxx**, xx xxx xxxxx xxxxx xxxxxxxxx xx xxx xxxxx xxxxx.

## Xxxxxxxxx

Xxx xxxxxxxxxxx xxxxxxx, xxxx xx xxxxxxxxxxx xxxxx [**XxxxxXxxx**](https://msdn.microsoft.com/en-us/library/windows/apps/mt620059.aspx) xxx xxxxxxxx xx xxx xxxxxxxx xxxxxxx xxx xxx xxxxxxxxxx xx xx xxx xxxxxxxx xxxxxxxx xx xxx xxxxxxx. Xxx xxxxxxxxxxx xxxx xxxxxx xxxx xxx xxxxxxxx xxx xxxxxx xxx, xx xxxx, xxx xxxxxxxxxxx xxxx xxxxxx xxxx xxx xxxxxx xxx xxxxxxx, xxxxxx xx xxxxxxxx xxx xxxxxxx xxxxxx xxxxxxxxx xx xx xxxxxxx xxxxxx xxxxxx xxxxxxxx xx xxxxx xxx xxxxxx xxxxxxx xxxxxxxxx. Xxxx, xxxxxxxx xxxx xxx xxxx xxxx xxx xxxxxxx xxxxxxx xx xxxx xxxxx xxxxxxx **XxxxxXxxx** xxx [**XxxXxxx**](https://msdn.microsoft.com/library/windows/apps/mt620060) xxxxx, xxxxx xx xxxxxxxxxx xxx xxx xxxxxxxxxxx xx xxxx xxxxxxxx xxxxxxxx xxx xx xxx xxxxxxx. Xxx xxxx xxxxxx, xx xxxxx x [**Xxxxxx**](https://msdn.microsoft.com/library/windows/apps/mt620063) xxxxxx, xxxxx xxxxxx xxx xxxxxxxxxxx xx xxxxxxx x xxxx-xxxxxxx xxxxx xxxx.

## Xxxxx Xxxxxxx

Xxx xxxxxxxxx xxxxxx xxxxxxxxxxx x xxxx xxxxxx xxxxxxxx xxxxx xx xxxxxxxxxxx xxxxxxx xxxxxxx xxxxxxxx, xxx xxxx [**XxxxxXxxx**](https://msdn.microsoft.com/en-us/library/windows/apps/mt620059.aspx) xxx [**XxxXxxx**](https://msdn.microsoft.com/library/windows/apps/mt620060) xx xxxxxxxx xxx xxxxxxxx xxxx xxxx. Xxx xxxxxxxxxxx xxxx XxxxxxXxxxx xx xxxxxx xxx xxxx (xxxxxxx xxx xxxxx) xxx xxxx xxxx XxxxxxYX xx xxxxxx xx. Xxx xxxxxxxxxxx xxxxxxxx xxxxxx xxxxxxx xxx XxxxxxYX xxxxxx xxxxxxxx xx xxxxxxxxxxxxxx xxxx. Xxxx xxxxxx **XxxxxXxxx** xx xxxxxx xx XXYXYXxxxxxXxxxxxx xxxxxxxxx xxxxxxx, xxxxx xx xxxxxxxxxxxx xxxx xxxxxxxxx xxxx xxxxxx xxx xxxxxxxxxxx xxxxxx x XxxxxxYX xxxxxxx xx xxxx x xxxxxxxx XXYXYYXxxxxxxYX xxxxxxxxx xx xxxx xxxxxxx xxxxxxxxx.

```cpp
//------------------------------------------------------------------------------
//
// Copyright (C) Microsoft. All rights reserved.
//
//------------------------------------------------------------------------------

#include "stdafx.h"

using namespace Microsoft::WRL;
using namespace Windows::Foundation;
using namespace Windows::Graphics::DirectX;
using namespace Windows::UI::Composition;

// This is an app-provided helper to render lines of text
class SampleText
{
private:
    // The text to draw
    ComPtr<IDWriteTextLayout> _text;

    // The composition surface that we use in the visual tree
    ComPtr<ICompositionDrawingSurfaceInterop> _drawingSurfaceInterop;

    // The device that owns the surface
    ComPtr<ICompositionGraphicsDevice> _compositionGraphicsDevice;

    // For managing our event notifier
    EventRegistrationToken _deviceReplacedEventToken;

public:
    SampleText(IDWriteTextLayout* text, ICompositionGraphicsDevice* compositionGraphicsDevice) :
        _text(text),
        _compositionGraphicsDevice(compositionGraphicsDevice)
    {
        // Create the surface just big enough to hold the formatted text block.
        DWRITE_TEXT_METRICS metrics;
        FailFastOnFailure(text->GetMetrics(&metrics));
        Windows::Foundation::Size surfaceSize = { metrics.width, metrics.height };
        ComPtr<ICompositionDrawingSurface> drawingSurface;
        FailFastOnFailure(_compositionGraphicsDevice->CreateDrawingSurface(
            surfaceSize,
            DirectXPixelFormat::DirectXPixelFormat_B8G8R8A8UIntNormalized,
            DirectXAlphaMode::DirectXAlphaMode_Ignore,
            &drawingSurface));

        // Cache the interop pointer, since that's what we always use.
        FailFastOnFailure(drawingSurface.As(&_drawingSurfaceInterop));

        // Draw the text
        DrawText();

        // If the rendering device is lost, the application will recreate and replace it. We then
        // own redrawing our pixels.
        FailFastOnFailure(_compositionGraphicsDevice->add_RenderingDeviceReplaced(
            Callback<RenderingDeviceReplacedEventHandler>([this](
                ICompositionGraphicsDevice* source, IRenderingDeviceReplacedEventArgs* args)
                -> HRESULT
            {
                // Draw the text again
                DrawText();
                return S_OK;
            }).Get(),
            &_deviceReplacedEventToken));
    }

    ~SampleText()
    {
        FailFastOnFailure(_compositionGraphicsDevice->remove_RenderingDeviceReplaced(
            _deviceReplacedEventToken));
    }

    // Return the underlying surface to the caller
    ComPtr<ICompositionSurface> get_Surface()
    {
        // To the caller, the fact that we have a drawing surface is an implementation detail.
        // Return the base interface instead
        ComPtr<ICompositionSurface> surface;
        FailFastOnFailure(_drawingSurfaceInterop.As(&surface));
        return surface;
    }

private:
    // We may detect device loss on BeginDraw calls. This helper handles this condition or other
    // errors.
    bool CheckForDeviceRemoved(HRESULT hr)
    {
        if (SUCCEEDED(hr))
        {
            // Everything is fine -- go ahead and draw
            return true;
        }
        else if (hr == DXGI_ERROR_DEVICE_REMOVED)
        {
            // We can't draw at this time, but this failure is recoverable. Just skip drawing for
            // now. We will be asked to draw again once the Direct3D device is recreated
            return false;
        }
        else
        {
            // Any other error is unexpected and, therefore, fatal
            FailFast();
        }
    }

    // Renders the text into our composition surface
    void DrawText()
    {
        // Begin our update of the surface pixels. If this is our first update, we are required
        // to specify the entire surface, which nullptr is shorthand for (but, as it works out,
        // any time we make an update we touch the entire surface, so we always pass nullptr).
        ComPtr<ID2D1DeviceContext> d2dDeviceContext;
        POINT offset;
        if (CheckForDeviceRemoved(_drawingSurfaceInterop->BeginDraw(nullptr,
            __uuidof(ID2D1DeviceContext), &d2dDeviceContext, &offset)))
        {
            // Create a solid color brush for the text. A more sophisticated application might want
            // to cache and reuse a brush across all text elements instead, taking care to recreate
            // it in the event of device removed.
            ComPtr<ID2D1SolidColorBrush> brush;
            FailFastOnFailure(d2dDeviceContext->CreateSolidColorBrush(
                D2D1::ColorF(D2D1::ColorF::Black, 1.0f), &brush));

            // Draw the line of text at the specified offset, which corresponds to the top-left
            // corner of our drawing surface. Notice we don't call BeginDraw on the D2D device
            // context; this has already been done for us by the composition API.
            d2dDeviceContext->DrawTextLayout(D2D1::Point2F(offset.x, offset.y), _text.Get(),
                brush.Get());

            // Our update is done. EndDraw never indicates rendering device removed, so any
            // failure here is unexpected and, therefore, fatal.
            FailFastOnFailure(_drawingSurfaceInterop->EndDraw());
        }
    }
};

class SampleApp
{
    ComPtr<ICompositor> _compositor;
    ComPtr<ID2D1Device> _d2dDevice;
    ComPtr<ICompositionGraphicsDevice> _compositionGraphicsDevice;
    std::vector<ComPtr<SampleText>> _textSurfaces;

public:
    // Run once when the application starts up
    void Initialize(ICompositor* compositor)
    {
        // Cache the compositor (created outside of this method)
        _compositor = compositor;

        // Create a Direct2D device (helper implementation not shown here)
        FailFastOnFailure(CreateDirect2DDevice(&_d2dDevice));

        // To create a composition graphics device, we need to QI for another interface
        ComPtr<ICompositorInterop> compositorInterop;
        FailFastOnFailure(_compositor.As(&compositorInterop));

        // Create a graphics device backed by our D3D device
        FailFastOnFailure(compositorInterop->CreateGraphicsDevice(
            _d2dDevice.Get(),
            &_compositionGraphicsDevice));
    }

    // Called when Direct3D signals the device lost event
    void OnDirect3DDeviceLost()
    {
        // Create a new device
        FailFastOnFailure(CreateDirect2DDevice(_d2dDevice.ReleaseAndGetAddressOf()));

        // Restore our composition graphics device to good health
        ComPtr<ICompositionGraphicsDeviceInterop> compositionGraphicsDeviceInterop;
        FailFastOnFailure(_compositionGraphicsDevice.As(&compositionGraphicsDeviceInterop));
        FailFastOnFailure(compositionGraphicsDeviceInterop->SetRenderingDevice(_d2dDevice.Get()));
    }

    // Create a surface that is asynchronously filled with an image
    ComPtr<ICompositionSurface> CreateSurfaceFromTextLayout(IDWriteTextLayout* text)
    {
        // Create our wrapper object that will handle downloading and decoding the image (assume
        // throwing new here)
        SampleText* textSurface = new SampleText(text, _compositionGraphicsDevice.Get());

        // Keep our image alive
        _textSurfaces.push_back(textSurface);

        // The caller is only interested in the underlying surface
        return textSurface->get_Surface();
    }

    // Create a visual that holds an image
    ComPtr<IVisual> CreateVisualFromTextLayout(IDWriteTextLayout* text)
    {
        // Create a sprite visual
        ComPtr<ISpriteVisual> spriteVisual;
        FailFastOnFailure(_compositor->CreateSpriteVisual(&spriteVisual));

        // The sprite visual needs a brush to hold the image
        ComPtr<ICompositionSurfaceBrush> surfaceBrush;
        FailFastOnFailure(_compositor->CreateSurfaceBrushWithSurface(
            CreateSurfaceFromTextLayout(text).Get(),
            &surfaceBrush));

        // Associate the brush with the visual
        ComPtr<ICompositionBrush> brush;
        FailFastOnFailure(surfaceBrush.As(&brush));
        FailFastOnFailure(spriteVisual->put_Brush(brush.Get()));

        // Return the visual to the caller as the base class
        ComPtr<IVisual> visual;
        FailFastOnFailure(spriteVisual.As(&visual));

        return visual;
    }

private:
    // This helper (implementation not shown here) creates a Direct2D device and registers
    // for a device loss notification on the underlying Direct3D device. When that notification is
    // raised, assume the OnDirect3DDeviceLost method is called.
    HRESULT CreateDirect2DDevice(ID2D1Device** ppDevice);
};
```

 

 




<!--HONumber=Mar16_HO1-->
